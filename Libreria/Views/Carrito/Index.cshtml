@model List<Libreria.Models.ItemCarrito>
@{
    Layout = null;
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link href="~/css/bootstrap-icons.css" rel="stylesheet">
@Html.Partial("_navbar")

<div class="container mt-2">
    <h5 class="text-dark fw-bold text-center" style="font-size: 1.50rem;">CESTA DE COMPRA</h5>

    <form id="carritoForm" method="post" action="@Url.Action("EliminarSeleccionados", "Carrito")">
        <table class="table table-striped table-bordered table-sm" id="carritoTable">
            <thead class="table-light">
                <tr>
                    <th>Seleccionar</th>
                    <th>Artículo</th>
                    <th class="text-center" style="width: 100px;">Cantidad</th>
                    <th>Precio Unitario</th>
                    <th class="text-center">Eliminar</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Count == 0)
                {
                    <tr>
                        <td colspan="5" class="text-center">Tu carrito está vacío.</td>
                    </tr>
                }
                else
                {
                    var itemsAgrupados = new Dictionary<string, ItemCarrito>();

                    foreach (var item in Model)
                    {
                        string key = item.LibroID.HasValue ? $"Libro_{item.LibroID}" : $"Separador_{item.SeparadorID}";

                        if (!itemsAgrupados.ContainsKey(key))
                        {
                            itemsAgrupados[key] = item;
                        }
                        else
                        {
                            itemsAgrupados[key].Cantidad += item.Cantidad;
                        }
                    }

                    foreach (var item in itemsAgrupados.Values)
                    {
                        <tr class="producto-row" data-item-id="@item.ItemCarritoID">
                            <td>
                                <input type="checkbox" name="selectedItems" value="@item.ItemCarritoID" class="item-checkbox" onclick="actualizarTotal()" />
                            </td>
                            <td>
                                @if (item.LibroID.HasValue)
                                {
                                    <div class="d-flex align-items-center">
                                        <div class="me-2">
                                            <img src="data:image/jpeg;base64,@Convert.ToBase64String(item.PortadaLibro)" alt="@item.Titulo" class="img-fluid" style="max-width: 60px; height: auto;" />
                                        </div>
                                        <div>
                                            <strong>@item.Titulo</strong> <br />
                                            @item.Autor
                                        </div>
                                    </div>
                                }
                                else if (item.SeparadorID.HasValue)
                                {
                                    <div class="d-flex align-items-center">
                                        <div class="me-2">
                                            <img src="data:image/jpeg;base64,@Convert.ToBase64String(item.FotoSeparador)" alt="@item.NombreSeparador" class="img-fluid" style="max-width: 60px; height: auto;" />
                                        </div>
                                        <div>
                                            @item.NombreSeparador
                                        </div>
                                    </div>
                                }
                            </td>
                            <td class="text-center">
                                <div class="input-group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cambiarCantidad('@item.ItemCarritoID', -1)">-</button>
                                    <input type="text" name="cantidades[@item.ItemCarritoID]" value="@item.Cantidad" class="form-control form-control-sm text-center" readonly />
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cambiarCantidad('@item.ItemCarritoID', 1)">+</button>
                                </div>
                            </td>
                            <td>
                                @if (item.LibroID.HasValue)
                                {
                                    <span class="text-success"> $@item.PrecioLibro</span>
                                }
                                else if (item.SeparadorID.HasValue)
                                {
                                    <span class="text-success"> $@item.PrecioSeparador</span>
                                }
                            </td>
                            <td>
                                <div class="text-center">
                                    <button type="button" class="btn btn-danger btn-sm" onclick="eliminarItem('@item.ItemCarritoID')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>

        <div class="d-flex justify-content-between mt-4">
            <a href="@Url.Action("Index", "Home")" class="btn btn-primary btn-sm">Seguir comprando</a>
            <div>
                <strong>Total a Pagar: $<span id="totalAPagar">0.00</span></strong>
            </div>
            <a href="@Url.Action("Crear", "Pedidos")" class="btn btn-success btn-sm" id="btnProcederPago">Realizar Pedido</a>
        </div>
    </form>
</div>

<script>
    function cambiarCantidad(itemId, cambio) {
        const cantidadInput = document.querySelector(`input[name='cantidades[${itemId}]']`);
        let nuevaCantidad = parseInt(cantidadInput.value) + cambio;

        if (nuevaCantidad < 1) {
            eliminarItem(itemId);
            return;
        }

        cantidadInput.value = nuevaCantidad;
        actualizarTotal();
    }

    function eliminarItem(itemId) {
        fetch('@Url.Action("EliminarItem", "Carrito")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': '@Html.AntiForgeryToken()'
            },
            body: JSON.stringify({ itemId: itemId })
        })
            .then(response => {
                if (response.ok) {
                    const row = document.querySelector(`tr[data-item-id='${itemId}']`);
                    row.remove();
                    actualizarTotal();
                } else {
                    alert("Hubo un error al eliminar el ítem.");
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function actualizarTotal() {
        let total = 0;
        const checkboxes = document.querySelectorAll('.item-checkbox:checked');

        checkboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const precio = parseFloat(row.querySelector('td:nth-last-child(2) span').innerText.replace('$', ''));
            const cantidad = parseInt(row.querySelector(`input[name='cantidades[${row.querySelector('.item-checkbox').value}]']`).value);
            total += precio * cantidad;
        });

        document.getElementById('totalAPagar').innerText = total.toFixed(2);
    }

    document.addEventListener('DOMContentLoaded', actualizarTotal);
</script>

<link rel="stylesheet" href="@Url.Content("~/css/vistacarro.css")">

<br />
<br />

<!-- Footer con íconos de redes y contacto -->
<footer style="background-color: #002B70;" class="text-white text-center py-4">
    <div class="container">
        <p>&copy; 2024 Librería El Maestro. Todos los derechos reservados.</p>
        <p>
            <i class="bi bi-telephone-fill"></i>
            <a href="tel:+18096817079" class="text-white text-decoration-none"> 809-681-7079</a>
        </p>
        <p>
            <i class="bi bi-envelope-fill"></i>
            <a href="mailto:libmaestro@hotmail.com" class="text-white text-decoration-none"> libmaestro@hotmail.com</a>
        </p>
        <p>
            <i class="bi bi-geo-alt-fill"></i>
            Dirección: C/Padre Castellanos No. 91, Ensanche Espaillat, Santo Domingo, República Dominicana.
        </p>
        <hr class="border border-light my-4">
        <p>Síguenos en nuestras redes sociales:</p>
        <div>
            <a href="https://facebook.com" class="text-white me-3">
                <i class="bi bi-facebook" style="font-size: 2rem;"></i>
            </a>
            <a href="https://instagram.com" class="text-white">
                <i class="bi bi-instagram" style="font-size: 2rem;"></i>
            </a>
        </div>
    </div>
</footer>
